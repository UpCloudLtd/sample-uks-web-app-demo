This is sample project that demonstrates how to set up UpCloud Kubernetes Service cluster and deploying Kubernetes 
guestbook example application to created cluster using UpCloud Terraform provider.

### Getting started

Initiate the project and install providers.

```
make init
```

Demo can now be created with Terraform. Creation takes around 10-15 minutes.

```
make create
```

### Testing UKS
After Terraform finishes you need to export kubeconfig as environment variable `export KUBECONFIG=kubeconfig.yml`.
After UKS control-plane has been created it will start creating worker nodes. You can monitor node status with `kubectl`.
```
kubectl get nodes
```
Ones all worker nodes are up, You start testing UKS with what ever application you want, but we have provided here few examples.

#### Hello UKS example
Create a deployment and expose it to the public Internet over HTTP by running the following commands:

```
kubectl create deployment --image=ghcr.io/upcloudltd/hello hello-uks
kubectl expose deployment hello-uks --port=80 --target-port=80 --type=LoadBalancer
kubectl get svc -w
```

This process will take a few minutes as our system will create a new load balancer to handle the traffic.

You can verify that it work by accessing Loadbalancer hostname in your browser or using 
`curl <Loadbalancer hostname>` command.

If you want to expose the service over HTTPS instead run the following:

```
kubectl expose deployment hello-uks --port=443 --target-port=80 --type=LoadBalancer --name=hello-uks-https
```

We provision a TLS certificate automatically for the autogenerated Load Balancer hostname.
#### Monitoring example
You might want to deploy monitoring to see how cluster resources are used during testing. 
We can use kube-prometheus project for fast and easy deployment for testing.

First clone the kube-prometheus project from Github.
```
git clone https://github.com/prometheus-operator/kube-prometheus.git
```
And then deploy it to UKS cluster.
```
kubectl apply --server-side -f kube-prometheus/manifests/setup
kubectl wait \
	--for condition=Established \
	--all CustomResourceDefinition \
	--namespace=monitoring
kubectl apply -f kube-prometheus/manifests/
```
Kube-prometheus project includes multiple components, but for now we want to just access Grafana dashboards.
For testing purposes, easy way to access Grafana is to use port-forwarding from your local computer localhost.

```
 kubectl --namespace monitoring port-forward svc/grafana 3000
```

Then access via [http://localhost:3000](http://localhost:3000) and use the default grafana user:password of `admin:admin`.
#### WordPress example
First you need to create kubernetes secret for storing MySQL credentials. You can use `make print` or `terraform output`
to see MySQL credential of DBaaS MySQL service terraform created.
You can do this by running the following command.
```
kubectl create secret generic mysql \
--from-file=user=credentials/mysql-user.txt \
--from-file=password=credentials/mysql-password.txt \
--from-file=database=credentials/mysql-db-name.txt \
--from-file=hostname=credentials/mysql-hostname.txt
```
Then you need to create persistent volume with UpCloud CSI driver
```
kubectl create  -f wordpress-example/upcloud-csi-volume.yaml  
```
Then you can deploy WordPress
```
kubectl create  -f wordpress-example/wordpress-deployment.yaml
```

After this you should verify when WordPress service is up. 

```
$ kubectl get services
NAME         TYPE           CLUSTER-IP      EXTERNAL-IP                                           PORT(S)          AGE
wordpress    LoadBalancer   10.128.90.14    lb-0a372fcc11e14cb9b9cced602c85c36a-1.upcloudlb.com   80:31033/TCP   4m1s
```
Then access hostname under EXTERNAL-IP with browser to finnish WordPress install.

### Wordpress with NFS 

First you need to deploy nfs-provisioner
```
helm repo add nfs-subdir-external-provisioner https://kubernetes-sigs.github.io/nfs-subdir-external-provisioner
helm install nfs-subdir-external-provisioner nfs-subdir-external-provisioner/nfs-subdir-external-provisioner \
  --create-namespace \
  --namespace nfs-provisioner \
  --set nfs.server=<nfs-server-ip> \
  --set nfs.path=/data
```


### Destroying stuff

After testing things its good to free the resources. Tearing the thing down is also just one command.

```
kubectl delete -f kube-prometheus/manifests/
kubectl delete -f wordpress-example/
make destroy
```

### License ###
This project is licensed under the MIT License - see the LICENSE.md file for details.